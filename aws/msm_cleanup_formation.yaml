AWSTemplateFormatVersion: 2010-09-09
Description: >
  Resources needed to deploy a scheduled lambda function.

####################################################################################
Resources:
####################################################################################

  MSMCleanupRole:
    Type: "AWS::IAM::Role"
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action:
              - sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::914445634489:policy/MSMCleanupLambdaPolicy

  MSMCleanupSchedule:
    Type: "AWS::Events::Rule"
    Properties:
      Description: >
        A schedule for the Lambda function..
      ScheduleExpression: "rate(1 day)"
      State: ENABLED
      Targets:
        - Arn: !Sub ${MSMCleanupLambdaFunction.Arn}
          Id: MSMCleanupSchedule

  MSMCleanupSchedulePermission:
    Type: "AWS::Lambda::Permission"
    Properties:
      Action: 'lambda:InvokeFunction'
      FunctionName: !Sub ${MSMCleanupLambdaFunction.Arn}
      Principal: 'events.amazonaws.com'
      SourceArn: !Sub ${MSMCleanupSchedule.Arn}

  MSMCleanupLambdaFunction:
    Type: "AWS::Lambda::Function"
    Properties:
      PackageType: Image
      Code:
        ImageUri: "914445634489.dkr.ecr.eu-west-3.amazonaws.com/cantlose:mft-msm-cleanup.beta.1"
      MemorySize: 128
      Role: !Sub ${MSMCleanupRole.Arn}
      Environment:
        Variables:
          NODE_ENV: "staging"
          KEY_REPORT_AT: "mat"
          DEBUG: "msm-cleanup:*,dynamolayer:*"
